// app.js - ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå

// -------------------------------------------------
// 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase (‡πÄ‡∏≠‡∏≤ Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!)
// -------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyD-jMhbBNhKhW6WviwLFF0zsA9Myp2SYiI",
  authDomain: "bmi-tracker-firebase.firebaseapp.com",
  projectId: "bmi-tracker-firebase",
  storageBucket: "bmi-tracker-firebase.firebasestorage.app",
  messagingSenderId: "917628551810",
  appId: "1:917628551810:web:ccf8296c9d0da08defea9b",
  measurementId: "G-F1Y7RV1GT7"
};

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

console.log("Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß!");

// -------------------------------------------------
// 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (Auth State Observer)
// -------------------------------------------------
auth.onAuthStateChanged((user) => {
    const path = window.location.pathname;
    const page = path.split("/").pop(); // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (index.html ‡∏´‡∏£‡∏∑‡∏≠ dashboard.html)

    if (user) {
        console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà:", user.email);
        
        // ‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Login -> ‡∏î‡∏µ‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard
        if (page === "index.html" || page === "") {
            window.location.href = "dashboard.html";
        }

        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard -> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        if (page === "dashboard.html") {
            setupUserProfile(user);
            loadHistory(user.uid);
        }

    } else {
        console.log("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard -> ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
        if (page === "dashboard.html") {
            window.location.href = "index.html";
        }
    }
});

// -------------------------------------------------
// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login (index.html)
// -------------------------------------------------
const loginBtn = document.getElementById('google-login-btn');
if (loginBtn) {
    loginBtn.addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then((result) => {
                console.log("Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", result.user);
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á Redirect ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ onAuthStateChanged ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á
            })
            .catch((error) => {
                console.error("Login ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
                alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            });
    });
}

// -------------------------------------------------
// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard
// -------------------------------------------------

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
function setupUserProfile(user) {
    const profilePic = document.getElementById('user-profile-pic');
    if (profilePic) {
        // ‡∏ñ‡πâ‡∏≤ user ‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ Google ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ default
        profilePic.src = user.photoURL || "assets/profile.png";
    }
    
    // ‡∏õ‡∏∏‡πà‡∏° Logout
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log("Logout ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            });
        });
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏® (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
function selectGender(gender) {
    document.getElementById('gender-male').classList.remove('active');
    document.getElementById('gender-female').classList.remove('active');
    const btn = document.getElementById('gender-' + gender);
    if(btn) btn.classList.add('active');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!)
function calculateBMI() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤
    const weight = document.getElementById('weight').value;
    const height = document.getElementById('height').value;
    const genderBtn = document.querySelector('.gender-card.active');

    // Validation
    if(!weight || !height) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö!"); return; }
    if(!genderBtn) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®!"); return; }

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    const h_meter = height / 100;
    const bmi = (weight / (h_meter * h_meter)).toFixed(1);
    const gender = genderBtn.id.replace("gender-", ""); // 'male' ‡∏´‡∏£‡∏∑‡∏≠ 'female'

    // 3. ‡πÅ‡∏õ‡∏•‡∏ú‡∏•
    let status = "", advice = "", color = "";
    if (bmi < 18.5) {
        status = "Underweight"; advice = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡πâ‡∏á"; color = "#FFC107";
    } else if (bmi < 24.9) {
        status = "Normal"; advice = "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏´‡∏∏‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠"; color = "#28A745";
    } else if (bmi < 29.9) {
        status = "Overweight"; advice = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 30 ‡∏ô‡∏≤‡∏ó‡∏µ"; color = "#FD7E14";
    } else {
        status = "Obese"; advice = "‡∏≠‡πâ‡∏ß‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á"; color = "#DC3545";
    }

    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    document.getElementById('bmi-value').innerText = bmi;
    document.getElementById('bmi-status').innerText = status;
    document.getElementById('bmi-status').style.color = color;
    document.getElementById('bmi-advice').innerText = advice;

    // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase Firestore ‚òÅÔ∏è
    const user = auth.currentUser;
    if (user) {
        db.collection("bmi_records").add({
            uid: user.uid,         // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£
            weight: Number(weight),
            height: Number(height),
            age: Number(document.getElementById('age').value) || 0,
            gender: gender,
            bmi: Number(bmi),
            status: status,
            advice: advice,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å Server
        }).then(() => {
            console.log("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
            loadHistory(user.uid);
        }).catch((error) => {
            console.error("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
        });
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Load History)
function loadHistory(uid) {
    const historyList = document.getElementById('history-list');
    if (!historyList) return;

    // ‡∏™‡∏±‡πà‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å collection 'bmi_records' ‡∏ó‡∏µ‡πà uid ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    db.collection("bmi_records")
        .where("uid", "==", uid)
        .orderBy("timestamp", "desc")
        .limit(10) // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        .get()
        .then((querySnapshot) => {
            let html = "";
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // ‡πÅ‡∏õ‡∏•‡∏á timestamp ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡πÜ
                const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('th-TH') : "-";
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° Badge
                let badgeClass = "normal";
                if(data.status.includes("Under")) badgeClass = "under"; // ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏° css class .under ‡πÄ‡∏≠‡∏≤‡πÄ‡∏≠‡∏á‡∏ô‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)
                else if(data.status.includes("Over")) badgeClass = "over";
                else if(data.status.includes("Obese")) badgeClass = "obese";

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                html += `
                <tr>
                    <td>${date}</td>
                    <td>${data.age}</td>
                    <td>${data.height}</td>
                    <td>${data.weight}</td>
                    <td style="text-transform: capitalize;">${data.gender}</td>
                    <td>${data.bmi}</td>
                    <td><span class="status-badge ${badgeClass}">${data.status}</span></td>
                    <td><button class="view-btn" onclick="openModal('${data.advice}')">VIEW</button></td>
                    <td><button class="delete-btn" onclick="deleteRecord('${doc.id}')">üóëÔ∏è</button></td>
                </tr>
                `;
            });
            historyList.innerHTML = html;
        })
        .catch((error) => {
            console.error("‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
        });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Delete)
function deleteRecord(docId) {
    if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
        db.collection("bmi_records").doc(docId).delete().then(() => {
            console.log("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            loadHistory(auth.currentUser.uid);
        }).catch((error) => {
            console.error("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
        });
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Modal (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
function openModal(text) {
    document.getElementById('modal-text').innerText = text;
    document.getElementById('advice-modal').style.display = 'flex';
}
function closeModal() {
    document.getElementById('advice-modal').style.display = 'none';
}
window.onclick = function(e) {
    if(e.target == document.getElementById('advice-modal')) closeModal();
}